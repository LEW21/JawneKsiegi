{% extends "kw/base.html" %}

{% load money %}

{% block title %}{% if account %}{{account.num_id}}. {{account.pub_name}}{% else %}{{block.super}}{% endif %}{% endblock %}

{% block top %}
	{% if account %}
		<h1>{{account.num_id}}.<br><small>{{account.pub_name}}</small></h1>
		<dl class="dl-horizontal" style="overflow: hidden;">
			{% if account.parent_id %}
				<dt>Konto syntetyczne</dt>
				<dd><a href="{{account.parent.url}}">{{account.parent.num_id}}. {{account.parent.pub_name}}</a></dd>
			{% endif %}
		</dl>
	{% else %}
		<h1>{{block.super}}</h1>
	{% endif %}
{% endblock top %}

{% block content %}

{% if account.children %}
	<h2>Subkonta</h2>
	{% with accounts=account.children level=account.levelP1 %}
		{% include "kw/_accounts.html" %}
	{% endwith %}
{% endif %}

{% if balance_accounts %}
	<h2>Konta bilansowe</h2>
	{% with accounts=balance_accounts level=0 %}
		{% include "kw/_accounts.html" %}
	{% endwith %}
{% endif %}

{% if nominal_accounts %}
	<h2>Konta wynikowe</h2>
	{% with accounts=nominal_accounts level=0 %}
		{% include "kw/_accounts.html" %}
	{% endwith %}
{% endif %}

<script>
function syncRows() {
	for (const row of document.querySelectorAll('.accounts tr')) {
		let visible = true
		let p = row
		while (p = p.parentRow)
			if (!p.classList.contains("expanded")) {
				visible = false
				break
			}
		row.style.display = visible ? null : 'none'
	}
}

for (const row of document.querySelectorAll('.accounts tr')) {
	const id = row.dataset.id || ''
	let children = document.querySelectorAll(".accounts tr[data-parent='" + id.replaceAll("'", "\\'") + "']")
	if (!children.length)
		row.classList.add("empty")

	row.parentRow = document.querySelector(".accounts tr[data-id='" + row.dataset.parent + "']")

	row.addEventListener('click', e => {
		if (e.target.href)
			return
		row.classList.toggle("expanded")
		syncRows()
		e.stopPropagation()
		e.preventDefault()
	})
}
</script>

{% if events %}
	<h2>Zdarzenia</h2>
	{% with has_balance=True %}
		{% include "kw/_account_events.html" %}
	{% endwith %}
{% endif %}

{% if future_events %}
	<h2>Planowane zdarzenia</h2>
	{% with events=future_events %}
		{% include "kw/_account_events.html" %}
	{% endwith %}
{% endif %}

{% endblock %}
